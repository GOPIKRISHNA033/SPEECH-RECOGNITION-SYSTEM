#include <Adafruit_Fingerprint.h>
#include <SoftwareSerial.h>

// Fingerprint sensor pins
SoftwareSerial fingerSerial(2, 3); // RX, TX
Adafruit_Fingerprint finger = Adafruit_Fingerprint(&fingerSerial);

// LED pins
const int whiteLED = 4;
const int redLED = 5;
const int greenLED = 6;
const int blueLED = 7;
const int buzzer = 8;

void setup() {
  Serial.begin(9600);
  finger.begin(57600);

  if (finger.verifyPassword()) {
    Serial.println("Fingerprint sensor ready.");
  } else {
    Serial.println("Fingerprint sensor not found.");
    while (1);
  }

  pinMode(whiteLED, OUTPUT);
  pinMode(redLED, OUTPUT);
  pinMode(greenLED, OUTPUT);
  pinMode(blueLED, OUTPUT);
  pinMode(buzzer, OUTPUT);

  digitalWrite(blueLED, HIGH); // Ready mode
}

void loop() {
  getFingerprintID();
  delay(50);
}

uint8_t getFingerprintID() {
  digitalWrite(whiteLED, HIGH); // Scanning
  uint8_t p = finger.getImage();
  digitalWrite(whiteLED, LOW);

  if (p != FINGERPRINT_OK) return p;

  p = finger.image2Tz();
  if (p != FINGERPRINT_OK) return p;

  p = finger.fingerSearch();
  if (p == FINGERPRINT_OK) {
    Serial.println("Fingerprint matched!");
    digitalWrite(greenLED, HIGH);
    tone(buzzer, 1000, 200);
    delay(1000);
    digitalWrite(greenLED, LOW);
  } else {
    Serial.println("Access Denied.");
    digitalWrite(redLED, HIGH);
    tone(buzzer, 500, 500);
    delay(1000);
    digitalWrite(redLED, LOW);
  }
  return p;
}
